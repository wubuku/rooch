// <autogenerated>
//   This file was generated by dddappp code generator.
//   Any changes made to this file manually will be lost next time the file is regenerated.
// </autogenerated>

package org.test.roochblogdemo.rooch.contract.service;

import com.github.wubuku.rooch.bean.GetAnnotatedStatesResponseMoveStructItem;
import com.github.wubuku.rooch.utils.RoochJsonRpcClient;
import org.test.roochblogdemo.domain.blog.*;
import org.test.roochblogdemo.domain.*;
import org.test.roochblogdemo.rooch.contract.ContractConstants;
import org.test.roochblogdemo.rooch.contract.DomainBeanUtils;
import org.test.roochblogdemo.rooch.bcs.BcsDomainBeanUtils;
import org.test.roochblogdemo.rooch.contract.Blog;

import java.util.*;
import java.math.*;
import java.util.function.*;

public class RoochBlogStateRetriever {

    private RoochJsonRpcClient roochJsonRpcClient;

    private Function<String, BlogState.MutableBlogState> blogStateFactory;


    public RoochBlogStateRetriever(RoochJsonRpcClient roochJsonRpcClient,
                                    Function<String, BlogState.MutableBlogState> blogStateFactory
    ) {
        this.roochJsonRpcClient = roochJsonRpcClient;
        this.blogStateFactory = blogStateFactory;
    }

    public BlogState retrieveBlogState(String accountAddress) {
        List<GetAnnotatedStatesResponseMoveStructItem<Blog>> getObjectListResponse = roochJsonRpcClient.getMoveStructAnnotatedStates(
                "/resource/" + accountAddress + "/" + accountAddress + "::" + ContractConstants.BLOG_MODULE_BLOG,
                Blog.class
        );
        if (getObjectListResponse.size() == 0 || getObjectListResponse.get(0) == null) {
            return null;
        }
        Blog blog = getObjectListResponse.get(0).getMoveValue().getValue();
        blog.setAccountAddress(accountAddress);
        return toBlogState(blog);
    }

    private BlogState toBlogState(Blog blog) {
        BlogState.MutableBlogState blogState = blogStateFactory.apply(blog.getAccountAddress());
        blogState.setVersion(blog.getVersion());
        blogState.setName(blog.getName());
        blogState.setArticles(new HashSet<>(Arrays.asList(blog.getArticles())));
        return blogState;
    }

}

